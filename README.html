<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Toni Verbeiren, Data Intuitive" />
  <title>DiFlow</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Roboto Condensed;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Source Code Pro;
      background-color: lightgrey;
      padding: .2em .4em;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      background-color: lightgrey;
      padding: 1em;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        background-color: #2a211c;
        color: #bdae9d;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
    div.sourceCode
      { color: #bdae9d; background-color: #2a211c; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ffff00; } /* Alert */
    code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { } /* Attribute */
    code span.bn { color: #44aa43; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #049b0a; } /* Char */
    code span.cn { } /* Constant */
    code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
    code span.do { color: #0066ff; font-style: italic; } /* Documentation */
    code span.dt { text-decoration: underline; } /* DataType */
    code span.dv { color: #44aa43; } /* DecVal */
    code span.er { color: #ffff00; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #44aa43; } /* Float */
    code span.fu { color: #ff9358; font-weight: bold; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
    code span.op { } /* Operator */
    code span.pp { font-weight: bold; } /* Preprocessor */
    code span.sc { color: #049b0a; } /* SpecialChar */
    code span.ss { color: #049b0a; } /* SpecialString */
    code span.st { color: #049b0a; } /* String */
    code span.va { } /* Variable */
    code span.vs { color: #049b0a; } /* VerbatimString */
    code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">DiFlow</h1>
<p class="author">Toni Verbeiren, Data Intuitive</p>
<p class="date">Tuesday - October 06, 2020</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#introduction">Introduction</a>
<ul>
<li><a href="#functional-reactive-programming-frp">Functional Reactive Programming (FRP)</a></li>
<li><a href="#frp-for-pipelines">FRP for pipelines</a></li>
</ul></li>
<li><a href="#nextflow">NextFlow</a>
<ul>
<li><a href="#introduction-1">Introduction</a></li>
<li><a href="#frp-in-nextflow">FRP in NextFlow</a></li>
<li><a href="#nextflow-dsl2">NextFlow DSL(2)</a></li>
</ul></li>
<li><a href="#diflow">DiFlow</a>
<ul>
<li><a href="#the-nopipeline-approach">The NoPipeline approach</a></li>
<li><a href="#general-requirements-and-design-principles">General Requirements and design principles</a>
<ul>
<li><a href="#reproducibility">Reproducibility</a></li>
<li><a href="#pipeline-parameters-vs-runtime-parameters">Pipeline Parameters vs Runtime Parameters</a></li>
<li><a href="#consistent-api">Consistent API</a></li>
<li><a href="#flat-module-structure">Flat Module Structure</a></li>
<li><a href="#job-serialization">Job Serialization</a></li>
</ul></li>
<li><a href="#an-abstract-computation-step">An abstract computation step</a></li>
<li><a href="#toward-implementation">Toward implementation</a></li>
</ul></li>
<li><a href="#step-by-step">Step by step</a>
<ul>
<li><a href="#step-1---operate-on-a-stream">Step 1 - Operate on a <em>stream</em></a></li>
<li><a href="#step-2---operate-on-a-stream-in-parallel">Step 2 - Operate on a stream in parallel</a></li>
<li><a href="#step-3---operate-on-a-stream-using-a-process">Step 3 - Operate on a stream using a <code>process</code></a></li>
<li><a href="#step-4---how-map-is-synchronous">Step 4 - How <code>map</code> is synchronous</a></li>
<li><a href="#step-5---introduce-an-id">Step 5 - Introduce an <code>ID</code></a></li>
<li><a href="#step-6---add-a-process-parameter">Step 6 - Add a process parameter</a></li>
<li><a href="#step-7---use-a-map-to-store-parameters">Step 7 - Use a <code>Map</code> to store parameters</a></li>
<li><a href="#step-8---use-a-map-with-a-process-key">Step 8 - Use a <code>Map</code> with a process-key</a></li>
<li><a href="#step-9---use-a-configmap-with-a-shell-script">Step 9 - Use a <code>ConfigMap</code> with a shell script</a></li>
<li><a href="#step-10---running-a-pipeline">Step 10 - Running a <em>pipeline</em></a></li>
<li><a href="#step-11---a-more-generic-process">Step 11 - A more generic process</a></li>
<li><a href="#step-12---mapreduce-in-nextflow">Step 12 - Map/reduce in NextFlow</a></li>
<li><a href="#step-13---files-as-inputoutput">Step 13 - Files as input/output</a></li>
<li><a href="#step-14---publishing-output">Step 14 - <em>Publishing</em> output</a></li>
<li><a href="#step-15---make-output-filespaths-unique">Step 15 - Make output files/paths unique</a></li>
<li><a href="#step-16---where-to-put-params">Step 16 - Where to put <code>params</code>?</a></li>
<li><a href="#step-17---add-the-output-file-to-params">Step 17 - Add the output file to <code>params</code></a></li>
<li><a href="#step-18---add-the-output-filename-to-the-triplet">Step 18 - Add the output filename to the triplet</a></li>
<li><a href="#step-19---use-a-closure">Step 19 - Use a closure</a></li>
<li><a href="#step-20---the-order-of-events-in-a-stream">Step 20 - The order of events in a stream</a></li>
<li><a href="#step-21---is-the-triplet-really-necessary">Step 21 - Is the <em>triplet</em> really necessary?</a></li>
<li><a href="#step-22---toward-generic-processes">Step 22 - Toward generic processes</a></li>
<li><a href="#step-23---more-than-one-input">Step 23 - More than one input</a></li>
<li><a href="#step-24---workflow-instead-of-process">Step 24 - <code>workflow</code> instead of <code>process</code></a></li>
<li><a href="#step-25---custom-scripts">Step 25 - Custom scripts</a></li>
<li><a href="#step-26---the-missing-link">Step 26 - The missing link</a></li>
<li><a href="#putting-it-all-together">Putting it all together</a>
<ul>
<li><a href="#generate-the-modules">Generate the modules</a></li>
<li><a href="#pipeline-main.nf">Pipeline <code>main.nf</code></a></li>
<li><a href="#pipeline-nextflow.config">Pipeline <code>nextflow.config</code></a></li>
<li><a href="#running-the-pipeline">Running the pipeline</a></li>
</ul></li>
</ul></li>
<li><a href="#what-is-missing-from-diflow">What is missing from DiFlow?</a>
<ul>
<li><a href="#parameter-checks">Parameter checks</a></li>
<li><a href="#multiple-output-file-references">Multiple output file references</a></li>
<li><a href="#per-sample-configuration">Per-sample configuration</a></li>
</ul></li>
<li><a href="#extras">Extras</a>
<ul>
<li><a href="#conditional-logic">Conditional logic</a></li>
<li><a href="#variables-in-nextflow.config">Variables in <code>nextflow.config</code></a></li>
</ul></li>
<li><a href="#appendix">Appendix</a>
<ul>
<li><a href="#caveats-and-tips">Caveats and Tips</a>
<ul>
<li><a href="#resources">Resources</a></li>
<li><a href="#default-values">Default values</a></li>
<li><a href="#target_image"><code>target_image</code></a></li>
<li><a href="#running-the-docker-setup">Running the Docker setup</a></li>
</ul></li>
<li><a href="#open-issues">Open issues</a></li>
</ul></li>
</ul>
</nav>
<h1 id="introduction">Introduction</h1>
<p><a href="https://pointer">DiFlow</a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> is an abstraction layer on top of <a href="https://www.nextflow.io/">NextFlow</a>’s <a href="https://www.nextflow.io/docs/latest/dsl2.html">DSL2</a>. DiFlow is a set of principles and guidelines for building NextFlow pipelines that allow the developer to declaratively define processing components and the user to declare the pipeline logic in a clean and intuitive way.</p>
<p><a href="http://data-intuitive.com/viash_docs">Viash</a> is a tool that (among other things) allows us to <em>use</em> DiFlow and make it practical, without the burden of maintaining boilerplate or <em>glue</em> code.</p>
<h2 id="functional-reactive-programming-frp">Functional Reactive Programming (FRP)</h2>
<p>If you’re new to Functional Reactive Programming (FRP), here are a few pointers to posts and a video that introduce the concepts:</p>
<ul>
<li>An excellent <a href="https://itnext.io/demystifying-functional-reactive-programming-67767dbe520b">Medium post</a> from Timo Stöttner</li>
<li>The <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">introduction</a> to Reactive Programming you’ve been missing from André Staltz.</li>
<li>A very insightful <a href="https://www.youtube.com/watch?v=fdol03pcvMA">presentation</a> by Staltz where he introduces FRP from first principles (with live coding).</li>
</ul>
<p>In what follows, we will refer to <em>streams</em> in line with those authors but if you’re used to working with <a href="http://reactivex.io/">Rx</a> you would call this an observable.</p>
<h2 id="frp-for-pipelines">FRP for pipelines</h2>
<p>Other initiatives have recognized that FRP is a good fit for pipeline development. Recent research and development also confirms this:</p>
<ul>
<li><a href="https://soft.vub.ac.be/~mathsaey/skitter/">Skitter</a></li>
<li><a href="https://github.com/weng-lab/krews">Krews</a></li>
</ul>
<h1 id="nextflow">NextFlow</h1>
<h2 id="introduction-1">Introduction</h2>
<p>For a step-by-step introduction to NextFlow (both the original DSL as well as DSL2), please refer to <a href="https://github.com/vibbits/nextflow-course">this repository</a> created and maintained by the <a href="https://vib.be/">VIB</a>.</p>
<p>Another very interesting resource is <a href="https://github.com/danrlu/Nextflow_cheatsheet">this cheatsheet</a> by Daniele Cook. It not only contains a handy cheat sheet, but also some conventions one should know about as well as some pitfalls.</p>
<h2 id="frp-in-nextflow">FRP in NextFlow</h2>
<p>The <a href="https://www.nextflow.io/docs/latest/channel.html"><code>Channel</code></a> class used by NextFlow, itself based on the <a href="https://en.wikipedia.org/wiki/Dataflow_programming">DataFlow Programming Model</a> can in fact be regarded as an implementation of a Functional Reactive Programming library. Having said that, NextFlow allows one to mix functional and imperative programming to the point that a developer is able to shoot its own foot.</p>
<p>Furthermore, <code>Channel</code>s can not be nested which complicates certain operations on the streams.</p>
<h2 id="nextflow-dsl2">NextFlow DSL(2)</h2>
<p><a href="https://www.nextflow.io/docs/latest/dsl2.html">DSL2</a> is a crucial development in NextFlow because it avoid having to maintain large, monolithic pipeline definitions in one file. With DSL2, developer can spin off functionality in separate files and <code>import</code> what is needed.</p>
<p>This also potentially opens up ways to build (reusable) modules that could be used in different projects. That is exactly what a lot of organizations need.</p>
<h1 id="diflow">DiFlow</h1>
<h2 id="the-nopipeline-approach">The NoPipeline approach</h2>
<p>For developing the pipeline, we set out with a few goals in mind:</p>
<ul>
<li>Build modules where each modules deals with a specific (computational) task</li>
<li>Make sure those modules can be reused</li>
<li>Make sure the module functionality can be tested and validated</li>
<li>Make sure modules have a consistent API, so that
<ol type="a">
<li>calling a module is straightforward</li>
<li>including a module in a pipeline is transparent and seamless</li>
</ol></li>
</ul>
<p>Please note that nothing in these requirements has to do with running a pipeline itself. Rather, we consider this a bottom-up system whereby we first focus on a solid foundation before we actually start to tie things together.</p>
<p>That’s why we call this the NoPipeline approach, similar to NoSQL where ‘No’ does not stand for <em>not</em>, but rather ‘Not Only’. The idea is to focus on the pipeline aspect <em>after</em> the steps are properly defined and tested.</p>
<h2 id="general-requirements-and-design-principles">General Requirements and design principles</h2>
<h3 id="reproducibility">Reproducibility</h3>
<p>I originally did not include it as a design principle for the simple reason that I think it’s obvious. This should be every researcher’s top priority.</p>
<h3 id="pipeline-parameters-vs-runtime-parameters">Pipeline Parameters vs Runtime Parameters</h3>
<p>We make a strict distinction between parameters that are defined for the <em>FULL</em> pipeline and those that are defined at runtime.</p>
<h4 id="pipeline-parameters">Pipeline Parameters</h4>
<p>We currently have 4 pipeline parameters: Docker prefix, <code>ddir</code>, <code>rdir</code> and <code>pdir</code>.</p>
<h4 id="runtime-parameters">Runtime Parameters</h4>
<p>Runtime parameters differ from pipeline parameters in that they may be different for parallel runs of a process. A few examples:</p>
<ul>
<li>Some samples may require different filter threshold than others</li>
<li>After concatenation, clustering may be run with different cluster parameters</li>
<li>etc.</li>
</ul>
<p>In other words, it does not make sense to define those parameters for the full pipeline because they are not static.</p>
<h3 id="consistent-api">Consistent API</h3>
<p>When we started out with the project and chose to use NextFlow as a workflow engine, I kept on thinking that the level of abstraction should have been higher. With DSL1, all you could do was create one long list of NextFlow code, tied together by <code>Channel</code>s.</p>
<p>With DSL2, it became feasible to <em>organise</em> stuff in separate NextFlow files and import what is required. But in larger codebases, this is not really a benefit because every modules/workflow may have its own parameters and output. No structure is imposed. <code>Workflow</code>s are basically functions taking parameters in and returning values.</p>
<p>I think it makes sense to define an API and to stick to it as much as possible. This makes using the modules/workflows easier…</p>
<h3 id="flat-module-structure">Flat Module Structure</h3>
<p>We want to avoid having nested modules, but rather support a pool of modules to be mixed and matched.</p>
<p>As a consequence, this allows a very low threshold for including third-party modules: just add it to the collection of modules and import it in the pipeline. In order to facilitate the inclusion of such third-party modules that are developed in their own respective repositories, we added one additional layer in the hierarchy allowing for such a splitting.</p>
<h3 id="job-serialization">Job Serialization</h3>
<p>We avoid requiring the sources of the job available in the runtime environment, i.e., the Docker container. In other words, all code and config is serialized and sent with the <em>process</em>.</p>
<h2 id="an-abstract-computation-step">An abstract computation step</h2>
<p>The module concept inspired us to think of an abstract way to represent a computation step and implement this in NextFlow. We wrote [Portash] to this end. But Portash had its shortcomings. The most important of which was that it did not adhere to separation of concerns: execution definition (what?) where mixed up with execution context (how?/where?). Moreover, dynamic nature of Portash lends itself well to running a tool as a service, but not so much in a batch process.</p>
<p>Nevertheless, we were able to express a generic NextFlow step as pure <em>configuration</em> that is passed to a process at runtime. This allows for some very interesting functionality. Some prototypes were developed, the last one of which could run a single-cell RNA pipeline from mapping to generating an integrated dataset combining different samples.</p>
<p>The run-configuration was provided by means of a Portash YAML spec residing in the module directory. It must be stressed that not requiring the component <em>code</em> to be already available inside the container is a big plus. It means a container contains dependencies, not the actual run script so the latter can be updated more frequently. This is especially useful during component and pipeline development.</p>
<p>Our first implementation had a few disadvantages:</p>
<ul>
<li>It contained a mix of what to run and how to run it, but it did not contain information on the container to run in. This had to be configured externally, but then the module is not an independent entity anymore.</li>
<li>Specifying and overriding YAML content in Groovy is possible, but not something that is intuitive. We worked around that by letting the user specify custom configuration using a Groovy nested <code>Map</code>.</li>
<li>The module functionality was abstracted with a consistent API and the difference between 2 modules was just a few lines of code with a different name or pointer. But still, one had to maintain that and making a similar change in a growing set of module files is a recipe for mistakes.</li>
</ul>
<p>But overall, the concept of an abstract computation step proved to work, it was just that a few ingredients were still missing it seemed. On the positive side, we showed that it’s possible to have an abstract API for (NextFlow) modules that keeps the underlying implementation hidden while improving the readability of the pipeline code.</p>
<h2 id="toward-implementation">Toward implementation</h2>
<p>What is needed as information in order to run a computation step in a pipeline?</p>
<ol type="1">
<li><p>First, we need data or generally speaking, <strong>input</strong>. Components/modules and pipelines should run zero-touch, so input has to be provided at startup time.</p></li>
<li><p>Secondly, we need to know what to run en how to run it. This is in effect the definition of a modules or pipeline step.</p></li>
<li><p>Thirdly, in many cases we will require the possibility to change parameters for individual modules in the pipeline, for instance cutoff values for a filter, or the number of clusters for a clustering algorithm. The classical way to do that is via the <code>params</code> object.</p></li>
</ol>
<p>One might wonder if there is a difference between input and parameters pointing to input is also a kind of parametrization. The reason those are kept apart is that additional validation steps are necessary for the data. Most pipeline systems trace input/output closely whereas parameters are ways to configure the steps in the pipeline.</p>
<p>In terms of FRP, and especially in the DataFlow model, we also have to keep track of the <em>forks</em> in a parallel execution scenario. For instance, if 10 batches of data can be processed in parallel we should give all 10 of them an ID so that individual forks can be distinguished. We will see that those IDs become crucial in most pipelines.</p>
<p>We end up with a model for a stream/channel as follows (conceptually):</p>
<pre><code>[ ID, data, config ]</code></pre>
<p>were</p>
<ul>
<li><code>ID</code> is just a string or any object for that matter that can be compared later. We usually work with strings.</li>
<li><code>data</code> is a pointer to the (input) data. With NextFlow, this should be a <code>Path</code> object, ideally created using the <code>file()</code> helper function.</li>
<li><code>config</code> is a nested <code>Map</code> where the first level keys are chosen to be simply an identifier of the pipeline step. Other approaches can be taken here, but that’s what we did.</li>
</ul>
<p>This can be a triplet, or a list with mixed types. In Groovy, both can be used interchangeably.</p>
<p>The output of a pipeline step/mudules adheres to the same structure so that pipeline steps can easily be chained.</p>
<h1 id="step-by-step">Step by step</h1>
<p>Let us illustrate some key features of NextFlow together with how we use them in DiFlow and approach this step by step.</p>
<p>The code blocks below are run with the following version of NextFlow:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> -v</span></code></pre></div>
<pre><code>nextflow version 20.10.0.5430</code></pre>
<h2 id="step-1---operate-on-a-stream">Step 1 - Operate on a <em>stream</em></h2>
<p>Let us illustrate the stream-like nature of a NXF <code>Channel</code> using a very simple example: computing <span class="math inline">1 + 1</span>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 1</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>workflow step1 {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>(<span class="dv">1</span>) \</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    | map{ it + <span class="dv">1</span> } \</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    | view{ it }</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This chunk is directly taken from <code>main.nf</code>, running it can be done as follows:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step1</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span></span></code></pre></div>
<h2 id="step-2---operate-on-a-stream-in-parallel">Step 2 - Operate on a stream in parallel</h2>
<p>NextFlow (and streams in general) are supposed to be a good fit for parallel execution. Let’s see how this can be done:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 2</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>workflow step2 {</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    | map{ it + <span class="dv">1</span> } \</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    | view{ it }</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Running it can be done using:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step2</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">4</span></span></code></pre></div>
<h2 id="step-3---operate-on-a-stream-using-a-process">Step 3 - Operate on a stream using a <code>process</code></h2>
<p>In the previous example, we ran 3 parallel executions each time applying the same simple function: adding one. Let us simulate now a more real-life example where parallel executions will not take the same amount of time. We do this by defining a <code>process</code> and <code>workflow</code> that uses this process. The rest is similar to our example before.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 3</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>process add {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  input:</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">val</span>(input)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">val</span>(output)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  exec:</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    output = input + <span class="dv">1</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>workflow step3 {</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    | add \</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    | view{ it }</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Running it is again the same.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step3</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">4</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span></span></code></pre></div>
<p>The result will be a permutation of 2,3 and 4. Try it multiple times to verify for yourself that the order is not guaranteed to be the same. Even though the execution times will not be that much different! In other words, a <code>Channel</code> does not guarantee the order, and that’s a good thing.</p>
<h2 id="step-4---how-map-is-synchronous">Step 4 - How <code>map</code> is synchronous</h2>
<p>An illustrative test is one where we do not use a <code>process</code> for the execution, but rather just <code>map</code> but such that one of the inputs <em>takes longer</em> to process, i.e.:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 4</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="dt">def</span> <span class="fu">waitAndReturn</span>(it) { <span class="fu">sleep</span>(<span class="dv">2000</span>); <span class="kw">return</span> it }</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>workflow step4 {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    | map{ (it == <span class="dv">2</span>) ? <span class="fu">waitAndReturn</span>(it) : it } \</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    | map{ it + <span class="dv">1</span> } \</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    | view{ it }</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Running it:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step4</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">4</span></span></code></pre></div>
<p>The result may be somewhat unexpected, the order is retained even though there’s a 2 second delay between the first entry and the rest. The <code>sleep</code> in other words blocks all the parallel execution branches.</p>
<p>This is a clear indication of why it’s better to use a <code>process</code> to execute computations. On the other hand, as long as we <em>stay</em> inside the <code>map</code> and don’t run a <code>process</code>, the order is retained. This opens up possibilities that we will exploit in what follows.</p>
<h2 id="step-5---introduce-an-id">Step 5 - Introduce an <code>ID</code></h2>
<p>If we can not guarantee the order of the different parallel branches, we should introduce a <em>branch ID</em>. This may be a label, a sample ID, a batch ID, etc. It’s the unit of parallelization.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 5</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>process addTuple {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  input:</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(id), <span class="fu">val</span>(input)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">val</span>(output)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  exec:</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    output = input + <span class="dv">1</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>workflow step5 {</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    | map{ el -&gt; [ el.<span class="fu">toString</span>(), el ]} \</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    | addTuple \</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    | view{ it }</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We can run this code sample in the same way as the previous examples:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step5</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">1</span>, 2]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">2</span>, 3]</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">3</span>, 4]</span></code></pre></div>
<p>Please note that the function to add 1 remains exactly the same, we only added the <code>id</code> as the first element of the tuple in both input and output. As such we keep a handle on which sample is which, by means of the <em>key</em> in the tuple.</p>
<p>Note: Later, we will extend this tuple and add configuration parameters to it… but this was supposed to go step by step.</p>
<h2 id="step-6---add-a-process-parameter">Step 6 - Add a process parameter</h2>
<p>What if we want to be able to configure the term in the sum? This would require a parameter to be sent with the process invocation. Let’s see how this can be done.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 6</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>process addTupleWithParameter {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  input:</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(id), <span class="fu">val</span>(input), <span class="fu">val</span>(term)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">val</span>(output)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  exec:</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    output = input + term</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>workflow step6 {</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    | map{ el -&gt; [ el.<span class="fu">toString</span>(), el, <span class="dv">10</span> ]} \</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    | addTupleWithParameter \</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    | view{ it }</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The result is:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step6</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">3</span>, 13]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">2</span>, 12]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">1</span>, 11]</span></code></pre></div>
<p>This works, but is not very flexible. What if we want to configure the operator as well? What if we want to have branch-specific configuration? We can add a whole list of parameters, but that means that the <code>process</code> signature may be different for every <code>process</code> that we define. That is not a preferred solution.</p>
<h2 id="step-7---use-a-map-to-store-parameters">Step 7 - Use a <code>Map</code> to store parameters</h2>
<p>Let us use a simple <code>Map</code> to add 2 configuration parameters:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 7</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>process addTupleWithMap {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  input:</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(id), <span class="fu">val</span>(input), <span class="fu">val</span>(config)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">val</span>(output)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  exec:</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    output = (config.<span class="fu">operator</span> == <span class="st">&quot;+&quot;</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                ? input + config.<span class="fu">term</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                : input - config.<span class="fu">term</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>workflow step7 {</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    | map{ el -&gt;</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>      [</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        el.<span class="fu">toString</span>(),</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        el,</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        [ <span class="st">&quot;operator&quot;</span> : <span class="st">&quot;-&quot;</span>, <span class="st">&quot;term&quot;</span> : <span class="dv">10</span> ]</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>      ] } \</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    | addTupleWithMap \</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    | view{ it }</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The result is:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step7</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">3</span>, -7]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">1</span>, -9]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">2</span>, -8]</span></code></pre></div>
<h2 id="step-8---use-a-map-with-a-process-key">Step 8 - Use a <code>Map</code> with a process-key</h2>
<p>Step 7 provides a way to use a consistent API for a process. Ideally, however, we would like different <code>process</code> invocation to be chained rather than to explicitly add the correct configuration all the time. Let us add an additional key to the map, so that a process knows <em>it’s scope</em>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 8</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>process addTupleWithProcessHash {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  input:</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(id), <span class="fu">val</span>(input), <span class="fu">val</span>(config)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">val</span>(output)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  exec:</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">def</span> thisConf = config.<span class="fu">addTupleWithProcessHash</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    output = (thisConf.<span class="fu">operator</span> == <span class="st">&quot;+&quot;</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>                ? input + thisConf.<span class="fu">term</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>                : input - thisConf.<span class="fu">term</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>workflow step8 {</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    | map{ el -&gt;</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>      [</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        el.<span class="fu">toString</span>(),</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        el,</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>        [ <span class="st">&quot;addTupleWithProcessHash&quot;</span> :</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>          [</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;operator&quot;</span> : <span class="st">&quot;-&quot;</span>,</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;term&quot;</span> : <span class="dv">10</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>          ]</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>      ] } \</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    | addTupleWithProcessHash \</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    | view{ it }</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Which yields:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step8</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">3</span>, -7]</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">2</span>, -8]</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">1</span>, -9]</span></code></pre></div>
<p>Please note that we used the process name as a key in the map, so that each process can tell what configuration parameter are relevant for its own scope. We call this <code>Map</code> a <code>ConfigMap</code>.</p>
<h2 id="step-9---use-a-configmap-with-a-shell-script">Step 9 - Use a <code>ConfigMap</code> with a shell script</h2>
<p>We used native Groovy code in the <code>process</code> examples above. Let us now use a shell script:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 9</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>process addTupleWithProcessHashScript {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  input:</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(id), <span class="fu">val</span>(input), <span class="fu">val</span>(config)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), stdout</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  script:</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">def</span> thisConf = config.<span class="fu">addTupleWithProcessHashScript</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">def</span> operator = thisConf.<span class="fu">operator</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">def</span> term = thisConf.<span class="fu">term</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="st">    echo \$( expr $input $operator ${thisConf.term} )</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>workflow step9 {</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    | map{ el -&gt;</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>      [</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>        el.<span class="fu">toString</span>(),</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>        el,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>        [ <span class="st">&quot;addTupleWithProcessHashScript&quot;</span> :</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>          [</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;operator&quot;</span> : <span class="st">&quot;-&quot;</span>,</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;term&quot;</span> : <span class="dv">10</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>          ]</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>      ] } \</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    | addTupleWithProcessHashScript \</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    | view{ it }</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Running this (in the same way as before), we get something along these lines:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step9</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">1</span>, -9</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">2</span>, -8</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>[<span class="ex">3</span>, -7</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<p>This is because the <code>stdout</code> qualifier captures the newline at the end of the code block. We could look for ways to circumvent that, but that is not the point here.</p>
<p>What’s important to notice here:</p>
<ol type="1">
<li>We can not just retrieve individual entries in <code>config</code> in the shell, we have to let Groovy do that.</li>
<li>That means we either first retrieve individual values and store them in a variable,</li>
<li>or we use the <code>${...}</code> notation for that.</li>
<li>If we want to use <code>bash</code> variables, the <code>$</code> symbol has to be escaped.</li>
</ol>
<p>Obviously, passing config like this requires a lot of typing (especially as additional parameters are introduced) and is error prone.</p>
<blockquote>
<p>A DiFlow module selects the appropriate key from a <code>ConfigMap</code> and uses that as its configuration settings. In a sense, we <em>scope</em> the global <code>ConfigMap</code> and use it as a local variable within a module. A module could also update the global <code>ConfigMap</code> and there may be cases where this is necessary, but care should be taken to update the global state like this.</p>
</blockquote>
<p>The scoping done can be seen as a <a href="https://medium.com/@dtipson/functional-lenses-d1aba9e52254">Functional Lens</a>, although it’s a poor man’s implementation at that. Furthermore, in some FRP frameworks, so-called <em>reducers</em> or <em>transducers</em> are used for transforming state in an application. We did not (yet) consider the further extension in that direction.</p>
<h2 id="step-10---running-a-pipeline">Step 10 - Running a <em>pipeline</em></h2>
<p>We used the pipe <code>|</code> symbol to combine different steps in a <em>pipeline</em> and we noticed that a <code>process</code> can do computations on parallel branches. That’s nice, but we have not yet given an example of running 2 processes, one after the other.</p>
<p>There are a few things we have to note before we go to an example:</p>
<ol type="1">
<li>It’s not possible to call the same process twice, a strange error occurs in that case<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</li>
<li>If we want to pipe the output of one process as input of the next, the I/O signature needs to be exactly the same, so the <code>output</code> of the <code>process</code> should be a triplet as well.</li>
</ol>
<div class="sourceCode" id="cb22"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 10</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>process process_step10a {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  input:</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(id), <span class="fu">val</span>(input), <span class="fu">val</span>(term)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">val</span>(output), <span class="fu">val</span>(<span class="st">&quot;${term}&quot;</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  exec:</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    output = input.<span class="fu">toInteger</span>() + term.<span class="fu">toInteger</span>()</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>process process_step10b {</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  input:</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(id), <span class="fu">val</span>(input), <span class="fu">val</span>(term)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">val</span>(output), <span class="fu">val</span>(<span class="st">&quot;${term}&quot;</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  exec:</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    output = input.<span class="fu">toInteger</span>() - term.<span class="fu">toInteger</span>()</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>workflow step10 {</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    | map{ el -&gt; [ el.<span class="fu">toString</span>(), el, <span class="dv">10</span> ] } \</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    | process_step10a \</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    | process_step10b \</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    | view{ it }</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The result of this is that first 10 is added and then the same 10 is subtracted again, which results in the same as the original. Please note that the output contains 3 elements, also the <code>term</code> passed to the <code>process</code>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step10</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">3</span>, 3, 10]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">1</span>, 1, 10]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">2</span>, 2, 10]</span></code></pre></div>
<p>We can configure the second <code>process</code> (subtraction) by adding an additional <code>map</code> in the mix:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 10a</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>workflow step10a {</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    | map{ el -&gt; [ el.<span class="fu">toString</span>(), el, <span class="dv">10</span> ] } \</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    | process_step10a \</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    | map{ id, value, term -&gt; [ id, value, <span class="dv">5</span> ] } \</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    | map{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>], <span class="dv">5</span> ] } \</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    | map{ x -&gt; [ x[<span class="dv">0</span>], x[<span class="dv">1</span>], <span class="dv">5</span> ] } \</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    | process_step10b \</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    | view{ it }</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Resulting in:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step10a</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">3</span>, 8, 5]</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">2</span>, 7, 5]</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">1</span>, 6, 5]</span></code></pre></div>
<p>Please note that we define the closure in a different manner here, using the special variable <code>it</code>. We could also write (to the same effect):</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  | map{ x -&gt; [ x[<span class="dv">0</span>], x[<span class="dv">1</span>], <span class="dv">5</span> ] } \</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  ...</span></code></pre></div>
<p>or even</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  | map{ id, value, term -&gt; [ id, value, <span class="dv">5</span> ] } \</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  ...</span></code></pre></div>
<h2 id="step-11---a-more-generic-process">Step 11 - A more generic process</h2>
<p>What if we rewrite the previous using some of the techniques introduced earlier. Let us specify the operator as a parameter and try to stick to just 1 <code>process</code> definition.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 11</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>process process_step11 {</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    input:</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(id), <span class="fu">val</span>(input), <span class="fu">val</span>(config)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    output:</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">val</span>(output), <span class="fu">val</span>(<span class="st">&quot;${config}&quot;</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    exec:</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> (config.<span class="fu">operator</span> == <span class="st">&quot;+&quot;</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>           output = input.<span class="fu">toInteger</span>() + config.<span class="fu">term</span>.<span class="fu">toInteger</span>()</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">else</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>           output = input.<span class="fu">toInteger</span>() - config.<span class="fu">term</span>.<span class="fu">toInteger</span>()</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>workflow step11 {</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    | map{ el -&gt; [ el.<span class="fu">toString</span>(), el, [ : ] ] } \</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    | process_step11 \</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    | map{ id, value, config -&gt;</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>      [</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        id,</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        value,</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        [ <span class="st">&quot;term&quot;</span> : <span class="dv">11</span>, <span class="st">&quot;operator&quot;</span> : <span class="st">&quot;-&quot;</span> ]</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>      ] } \</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    | process_step11 \</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    | view{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>] ] }</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This little workflow definition results in an error, just like we warned before:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step11</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="ex">assert</span> processConfig==null</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>       <span class="kw">|</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>       [<span class="st">&#39;echo&#39;</span>:<span class="ex">false</span>, <span class="st">&#39;cacheable&#39;</span>:true, <span class="st">&#39;shell&#39;</span>:[<span class="st">&#39;/bin/bash&#39;</span>, <span class="st">&#39;-ue&#39;</span>], <span class="st">&#39;validExitStatus&#39;</span>:[0], <span class="st">&#39;maxRetries&#39;</span>:0, <span class="st">&#39;maxErrors&#39;</span>:-1, <span class="st">&#39;errorStrategy&#39;</span>:TERMINATE]</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">--</span> Check script <span class="st">&#39;main.nf&#39;</span> at line: 248 or see <span class="st">&#39;.nextflow.log&#39;</span> file for more details</span></code></pre></div>
<p>There is, however, one simple way around this: <code>include { ... as ...}</code>. Let us see how this works.</p>
<p>First, we store the <code>process</code> in a file <code>examples/step/step11.nf</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>process process_step11 {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  input:</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(id), <span class="fu">val</span>(input), <span class="fu">val</span>(config)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">val</span>(output), <span class="fu">val</span>(<span class="st">&quot;${config}&quot;</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  exec:</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> (config.<span class="fu">operator</span> == <span class="st">&quot;+&quot;</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>      output = input.<span class="fu">toInteger</span>() + config.<span class="fu">term</span>.<span class="fu">toInteger</span>()</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>      output = input.<span class="fu">toInteger</span>() - config.<span class="fu">term</span>.<span class="fu">toInteger</span>()</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>workflow</code> definition becomes:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 11a</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>include { process_step11 <span class="kw">as</span> process_step11a } \</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  from <span class="st">&#39;./examples/modules/step11.nf&#39;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>include { process_step11 <span class="kw">as</span> process_step11b } \</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  from <span class="st">&#39;./examples/modules/step11.nf&#39;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>workflow step11a {</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    | map{ el -&gt; [ el.<span class="fu">toString</span>(), el, [ : ] ] } \</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    | map{ id, value, config -&gt;</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>      [</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        id,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        value,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        [ <span class="st">&quot;term&quot;</span> : <span class="dv">5</span>, <span class="st">&quot;operator&quot;</span> : <span class="st">&quot;+&quot;</span> ]</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>      ] } \</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    | process_step11a \</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    | map{ id, value, config -&gt;</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>      [</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        id,</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        value,</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        [ <span class="st">&quot;term&quot;</span> : <span class="dv">11</span>, <span class="st">&quot;operator&quot;</span> : <span class="st">&quot;-&quot;</span> ]</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>      ] } \</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    | process_step11b \</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    | view{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>] ] }</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Running this yields an output similar to this:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step11a</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">2</span>, -4]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">1</span>, -5]</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">3</span>, -3]</span></code></pre></div>
<p>We made a few minor changes to the workflow code in the meanwhile:</p>
<ol type="1">
<li>Splitting the conversion from an array of items to the triplet is now done explicitly and separate from specifying the configuration for the <code>process</code> itself.</li>
<li>The <code>view</code> now only contains the relevant parts, not the configuration part for the last <code>process</code>.</li>
</ol>
<p>The above example illustrates the <code>include</code> functionality of NextFlow DSL2. This was not possible with prior versions.</p>
<h2 id="step-12---mapreduce-in-nextflow">Step 12 - Map/reduce in NextFlow</h2>
<p>Let’s implement a simple map/reduce schema with what we developed above. Until now, we basically covered the mapping stage: starting from 3 independent number, execute a function on each <em>branch</em> individually. Now, we want to calculate the sum at the end (reduce phase).</p>
<p>We do this by adding a <code>process</code> to the example in Step 10</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 12</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>process process_step12 {</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  input:</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(id), <span class="fu">val</span>(input), <span class="fu">val</span>(term)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">val</span>(output), <span class="fu">val</span>(<span class="st">&quot;${term}&quot;</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  exec:</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    output = input.<span class="fu">sum</span>()</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>workflow step12 {</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] ) \</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    | map{ el -&gt; [ el.<span class="fu">toString</span>(), el, <span class="dv">10</span> ] } \</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    | process_step10a \</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    | toList \</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    | map{</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>      [</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;sum&quot;</span>,</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        it.<span class="fu">collect</span>{ id, value, config -&gt; value },</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        [ : ]</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>      ] } \</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    | process_step12 \</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    | view{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>] ] }</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Running this yields:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step12</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">sum</span>, 36]</span></code></pre></div>
<p>A few remarks are in order here:</p>
<ol type="1">
<li>We use the <code>toList</code> operator on the output of <code>process_step10a</code>. This can be regarded as merging the 3 parallel branches into one branch. The result has the signature <code>Channel[List[Triplet]]</code>. This <code>toList</code> operator only <em>outputs</em> something on the output <code>Channel</code> when all incoming branches have finished and the <em>merge</em> can effectively be performed.</li>
<li>It’s important to note that what is passed through the pipe is still a <code>Channel</code>, only the number of <em>branches</em>, <em>nodes</em>, or whatever you want to call it differs.</li>
<li>The long <code>map{ [ &quot;sum&quot;, ... }</code> line may seem complex at first, but it’s really not. We take in <code>List[Triplet]</code> and convert this to <code>Triplet</code>. The first element of the triplet is just an identifier (<code>sum</code>). The last is the configuration map, but we don’t need configuration for the sum. As the second element we want to obtain <code>List[Int]</code>, where the values are the 2nd element from the original triplets. The Groovy function <code>collect</code> on an array is like <code>map</code> in many other languages.</li>
</ol>
<p>The marble diagram can be depicted conceptually as follows, where we note that in effect it’s triplets rather than numbers that are contained in the marbles:</p>
<p><img src="data:image/png;base64,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QBALfzsIYuFmlEiwgHbgnzlzpi1YsMC2bNkSVFN9O/Lqq6+2fv36sWN+kBwnI4BAUgQIYuEtSRALN6NEDRFYtWqVrVixwtasWWPvvvuubdu2zfbs2eNqX6tWLWvQoIHbILZdu3ZWUlJiHTp0qCEyVBMBBBBIL0AQC38zCGLhZpRAAAEEEEAAgTQCBLHw14IgFm5GCQQQQAABBBAgiOXkHSCI5YSRiyCAAAIIIIAAPWLh7wBBLNyMEggggAACCCBAj1hO3gGCWE4YuQgCCCCAAAII0CMW/g4QxMLNKIEAAggggAACCOREgCCWE0YuggACCCCAAAIIhAsQxMLNKIEAAggggAACCOREgCCWE0YuggACCCCAAAIIhAsQxMLNKIEAAggggAACCOREgCCWE0YuggACCCCAAAIIhAsQxMLNKIEAAggggAACCOREgCCWE0YuggACCCCAAAIIhAsQxMLNKIEAAggggAACCOREgCCWE0YuggACCCCAAAIIhAsQxMLNKIEAAggggAACCOREgCCWE0YuggACCCCAAAIIhAsQxMLNKIEAAggggAACCOREgCCWE0YuggACCCCAAAIIhAsQxMLNKIEAAggggAACCOREgCCWE0YuggACCCCAAAIIhAsQxMLNKIEAAggggAACCOREgCCWE0YuggACCCCAAAIIhAsQxMLNKIEAAggggAACCOREgCCWE0YuggACCCCAAAIIhAsQxMLNKIEAAggggAACCOREgCCWE0YuggACCCCAAAIIhAsQxMLNKIEAAggggAACCOREgCCWE0YuggACCCCAAAIIhAsQxMLNKIEAAggggAACCORE4P8AP6rmbpgQFtMAAAAASUVORK5CYII=" style="width:50.0%" /></p>
<p>Please note that though we define the <em>pipeline</em> sequentially, the 3 numbers are first handled in parallel and only combined when calling <code>toList</code>. Stated differently, parallelism comes for free when defining workflows like this.</p>
<!--
Marble spec, to be used on swirly.dev to reproduce the figure
-abc-------------|
a := 1
b := 2
c := 3

> process_10a

--def------------|
d := 11
e := 12
f := 13

> toList

-----g-----------|
g := [11, 12, 13]

> process_step12

------g----------|
g := 36
-->
<h2 id="step-13---files-as-inputoutput">Step 13 - Files as input/output</h2>
<p>Let us tackle a different angle now and start to deal with files as input and output. In order to do this, we will mimic the functionality from earlier and modify it such that a file is used as input and output is also written to a file.</p>
<p>The following combination of <code>process</code> and <code>workflow</code> definition does exactly the same as before, but now from one or more files containing just a single integer number:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 13</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>process process_step13 {</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  input:</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(id), <span class="fu">file</span>(input), <span class="fu">val</span>(config)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">file</span>(<span class="st">&quot;output.txt&quot;</span>), <span class="fu">val</span>(<span class="st">&quot;${config}&quot;</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  script:</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="st">    a=`cat $input`</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="st">    let result=&quot;\$a + ${config.term}&quot;</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="st">    echo &quot;\$result&quot; &gt; output.txt</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>workflow step13 {</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span>.<span class="fu">fromPath</span>( params.<span class="fu">input</span> ) \</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    | map{ el -&gt;</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>      [</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>        el.<span class="fu">baseName</span>.<span class="fu">toString</span>(),</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>        el,</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>        [ <span class="st">&quot;operator&quot;</span> : <span class="st">&quot;-&quot;</span>, <span class="st">&quot;term&quot;</span> : <span class="dv">10</span> ]</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>      ]} \</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    | process_step13 \</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    | view{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>] ] }</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>While doing this, we also introduced a way to specify parameters via a configuration file (<code>nextflow.config</code>) or from the CLI. In this case <code>params.input</code> points to an argument we should provide on the CLI, for instance:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step13 --input data/input1.txt</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input1</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/ad/7b121548b34a65896690ee4090bafa/output.txt]</span></code></pre></div>
<p>Let’s dissect what is going on here…</p>
<ol type="1">
<li>We provide the input file <code>data/input1.txt</code> as input which gets automatically added to the <code>params</code> map as <code>params.input</code>.</li>
<li>The content of <code>input1.txt</code> is used in the simple sum just as before.</li>
<li>The output <code>Channel</code> contains the known triplet but this time the second entry is not a value, but rather a filename.</li>
</ol>
<p>Please note that the file is <code>output.txt</code> is automatically stored in the (unique) <code>work</code> directory. We can take a look inside to verify that the calculation succeeded:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="fu">cat</span> <span class="va">$(</span><span class="ex">nextflow</span> log <span class="kw">|</span> <span class="fu">cut</span> -f 3 <span class="kw">|</span> <span class="fu">tail</span> -1 <span class="kw">|</span> <span class="fu">xargs</span> nextflow log<span class="va">)</span>/output.txt</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="ex">11</span></span></code></pre></div>
<p>It seems the calculation went well, although one might be surprised by two things:</p>
<ol type="1">
<li>The output of the calculation is stored in some randomly generated <code>work</code> directory whereas we might want it somewhere more <em>findable</em>.</li>
<li>The <code>process</code> itself defines the value of the output filename, which may seem odd… and it is.</li>
</ol>
<p>Taking our example a bit further and exploiting the fact that parallelism is natively supported by NextFlow as we’ve seen before, we can pass multiple input files to the same workflow defined above.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step13 --input <span class="st">&quot;data/input?.txt&quot;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input2</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/d7/34a9b391ed1b04d44ea36f18d33b75/output.txt]</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input1</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/5a/f792287cf1cd43737b8ed0b332e06e/output.txt]</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input3</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/27/01054814bc54a74b7185840c568756/output.txt]</span></code></pre></div>
<p>Please note that we</p>
<ol type="1">
<li>provide the absolute path to the file</li>
<li>use a wildcard <code>*</code> to select multiple files</li>
<li>enclose the path (with wildcard) in double quotes to avoid shell globbing.</li>
</ol>
<p>In the latter case, we end up with 3 output files, each named <code>output.txt</code> in their own respective (unique) <code>work</code> directory.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> log <span class="kw">|</span> <span class="fu">cut</span> -f 3 <span class="kw">|</span> <span class="fu">tail</span> -1 <span class="kw">|</span> <span class="fu">xargs</span> nextflow log <span class="kw">|</span> <span class="fu">xargs</span> ls</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span><span class="ex">...</span><span class="op">&gt;</span>/work/21/a6c981c5aac093b4ca2471d10764b2:</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="ex">input2.txt</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="ex">output.txt</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span><span class="ex">...</span><span class="op">&gt;</span>/work/98/ba7eab3377d223a02aeba113c9c23e:</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="ex">input3.txt</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="ex">output.txt</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span><span class="ex">...</span><span class="op">&gt;</span>/work/ce/0a9b1213399d7441c79635f29cdf02:</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="ex">input1.txt</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="ex">output.txt</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span><span class="ex">...</span><span class="op">&gt;</span>/work/f6/e5cbf16076144e0e867f7e7329a183:</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="ex">input.txt</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="ex">output.txt</span></span></code></pre></div>
<h2 id="step-14---publishing-output">Step 14 - <em>Publishing</em> output</h2>
<p>Let us tackle one of the pain points of the previous example: output files are hidden in the <code>work</code> directory. One might be tempted to specify an output file in the <code>process</code> definition as such <code>file(&quot;&lt;somepath&gt;/output.txt&quot;)</code> but when you try this, it will quickly turn out that this does not work in the long run (though it may work for some limited cases).</p>
<p>NextFlow provides a better way to achieve the required functionality: <a href="https://www.nextflow.io/docs/latest/process.html?highlight=publish#publishdir"><code>publishDir</code></a>. Let us illustrate its use with an example again and just adding the <code>publishDir</code> directive:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 14</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>process process_step14 {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;output/&quot;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    input:</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(id), <span class="fu">file</span>(input), <span class="fu">val</span>(config)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    output:</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">file</span>(<span class="st">&quot;output.txt&quot;</span>), <span class="fu">val</span>(<span class="st">&quot;${config}&quot;</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    script:</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="st">        a=`cat $input`</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="st">        let result=&quot;\$a + ${config.term}&quot;</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;\$result&quot; &gt; output.txt</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>workflow step14 {</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span>.<span class="fu">fromPath</span>( params.<span class="fu">input</span> ) \</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        | map{ el -&gt;</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>          [</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>            el.<span class="fu">baseName</span>.<span class="fu">toString</span>(),</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>            el,</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>            [ <span class="st">&quot;operator&quot;</span> : <span class="st">&quot;-&quot;</span>, <span class="st">&quot;term&quot;</span> : <span class="dv">10</span> ]</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>          ]} \</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>        | process_step14 \</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>        | view{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>] ] }</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This single addition yields:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step14 --input data/input1.txt</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input1</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/e5/1033cc086eb4d913676bca21a93b38/output.txt]</span></code></pre></div>
<p>This example shows us a powerful approach to publishing data. There is a similar drawback as for the output filenames, however, and that is that the <code>process</code> defines the output directory explicitly. But there is a different problem as well, which can be observed when running on multiple input files:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step14 --input <span class="st">&quot;data/input?.txt&quot;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input3</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/92/063e73bf15dbc5f531004b6195446e/output.txt]</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input1</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/b3/819250d5dfc8b079ca5ebc07a44a8b/output.txt]</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input2</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/91/2f8eaf444c3d72dc9e07925d541496/output.txt]</span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="fu">cat</span> output/output.txt</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="ex">12</span></span></code></pre></div>
<p>What do you think happens here? Yes, sure, we <em>publish</em> the same <code>output.txt</code> file three times and each time overwriting the same file. The last one is the one that persists.</p>
<h2 id="step-15---make-output-filespaths-unique">Step 15 - Make output files/paths unique</h2>
<p>Let us describe a way to avoid the above issue. There are other approaches to resolve this issue, but let us for the moment look at one that can easily be reused.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 15</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>process process_step15 {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;output/${config.id}&quot;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    input:</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(id), <span class="fu">file</span>(input), <span class="fu">val</span>(config)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    output:</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">file</span>(<span class="st">&quot;output.txt&quot;</span>), <span class="fu">val</span>(<span class="st">&quot;${config}&quot;</span>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    script:</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="st">        a=`cat $input`</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="st">        let result=&quot;\$a + ${config.term}&quot;</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;\$result&quot; &gt; output.txt</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>workflow step15 {</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span>.<span class="fu">fromPath</span>( params.<span class="fu">input</span> ) \</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>        | map{ el -&gt;</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>              el.<span class="fu">baseName</span>,</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>              el,</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>              [</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;id&quot;</span>: el.<span class="fu">baseName</span>,</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;operator&quot;</span> : <span class="st">&quot;-&quot;</span>,</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;term&quot;</span> : <span class="dv">10</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>              ]</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>            ] } \</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>        | process_step15 \</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>        | view{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>] ] }</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This results in the following:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step15 --input <span class="st">&quot;data/input?.txt&quot;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input2</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/b9/3eed9b57cb7bf71effdc4f065200f0/output.txt]</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input3</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/12/66ae79381a6d148499e24fa0b7a6ae/output.txt]</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input1</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/d7/94582176b74a2283ab258eaa8dd46c/output.txt]</span></code></pre></div>
<p>With the following result:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="fu">cat</span> output/input?/output.txt</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="ex">11</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="ex">12</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="ex">13</span></span></code></pre></div>
<p>In other words, since (in this case 3) parallel branches each write to the same output location we have to make sure that we add something unique for every of the parallel branches. Another approach is to tweak the name of the output file in the <code>process</code>, but for the moment it is still fixed and defined in the <code>process</code> itself. Let us take a look at that aspect next.</p>
<h2 id="step-16---where-to-put-params">Step 16 - Where to put <code>params</code>?</h2>
<p>We want the output filename to be configurable. That means that we either use the <code>params</code> map for this (and take care it is available in modules that are <code>include</code>d) or we pass it to the <code>process</code> as part of the input. Let us explore both scenarios.</p>
<p>But first, we need to understand a bit better where the contents of <code>params</code> comes from. We already covered a few examples where we specify a <code>params</code> key on the CLI. There is another way as well, via <code>nextflow.config</code>. In it, we can add a scope <code>params</code> and add the configuration there.</p>
<p>Let us reconsider the previous example (<code>step15</code>) but this time add a <code>nextflow.config</code> file like this (please update the <code>&lt;...&gt;</code> part according to your situation):</p>
<p>params.input = “$PWD/data/input?.txt”</p>
<p>Let us illustrate the effect by means of two examples:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step15</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input3</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/8e/486c71e3f1f381d91be01110b6455c/output.txt]</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input1</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/7f/6bf5a5856debdf0bd18e79e61c4c16/output.txt]</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input2</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/02/df9fe556a44edf8248abab72184d33/output.txt]</span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step15 --input data/input1.txt</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input1</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/f1/6d9cb929ffa0e85846927c091a8086/output.txt]</span></code></pre></div>
<p>In other words, <code>params</code> can be defined in <code>nextflow.config</code> but if it appears on the CLI then the latter gets priority. Please be reminded that <code>params</code> is a map, the following is equivalent:</p>
<pre><code>params {
    input = &quot;/.../diflow/data/*.txt&quot;
}</code></pre>
<h2 id="step-17---add-the-output-file-to-params">Step 17 - Add the output file to <code>params</code></h2>
<p>In this case, we would add a <code>output = ...</code> key to <code>nextflow.config</code> or provide <code>--output ...</code> on the CLI. This is done in the following example:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 17</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>process process_step17 {</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;output&quot;</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    input:</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(id), <span class="fu">file</span>(input), <span class="fu">val</span>(config)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    output:</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">file</span>(params.<span class="fu">output</span>), <span class="fu">val</span>(<span class="st">&quot;${config}&quot;</span>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    script:</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="st">        a=`cat $input`</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="st">        let result=&quot;\$a + ${config.term}&quot;</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;\$result&quot; &gt; ${params.output}</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>workflow step17 {</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span>.<span class="fu">fromPath</span>( params.<span class="fu">input</span> ) \</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>        | map{ el -&gt;</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>          [</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>            el.<span class="fu">baseName</span>.<span class="fu">toString</span>(),</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>            el,</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;id&quot;</span>: el.<span class="fu">baseName</span>,</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;operator&quot;</span> : <span class="st">&quot;-&quot;</span>,</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;term&quot;</span> : <span class="dv">10</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>          ] } \</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>        | process_step17 \</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>        | view{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>] ] }</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The code that is run:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step17 --input data/input.txt --output output.txt</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/d7/9357bd9a68e9a7158733b3879d6c1a/output.txt]</span></code></pre></div>
<p>The result is:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="fu">cat</span> output/output.txt</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="ex">11</span></span></code></pre></div>
<p>We note that the <code>params.output</code> occurs in the <code>output:</code> triplet as well as in the script code itself. That’s quite important, otherwise NextFlow will complain the output file can not be found.</p>
<p>This approach does what it is supposed to do: make the output filename configurable. There are a few drawbacks however:</p>
<ol type="1">
<li>We would have to configure the filename for <em>every</em> process individually. While this can be done (<code>params.&lt;process&gt;.output</code> for instance), it requires additional bookkeeping on the side of the pipeline developer.</li>
<li>It does not help much because the output filename for every parallel branch again has the same name. In other words, we still have to have the <code>publishDir</code></li>
</ol>
<p>In all fairness, these issues only arise when you want to <em>publish</em> the output data because in the other case every process <em>lives</em> in its own (unique) <code>work</code> directory.</p>
<h2 id="step-18---add-the-output-filename-to-the-triplet">Step 18 - Add the output filename to the triplet</h2>
<p>The other approach to take is to add the output filename to the triplet provided as input to the <code>process</code>. This can be done similarly to what we did with the input filename, i.e.:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 18</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>process process_step18 {</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;output&quot;</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    input:</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(id), <span class="fu">file</span>(input), <span class="fu">val</span>(config)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    output:</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">file</span>(<span class="st">&quot;${config.output}&quot;</span>), <span class="fu">val</span>(<span class="st">&quot;${config}&quot;</span>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    script:</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="st">        a=`cat $input`</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="st">        let result=&quot;\$a + ${config.term}&quot;</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;\$result&quot; &gt; ${config.output}</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>workflow step18 {</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span>.<span class="fu">fromPath</span>( params.<span class="fu">input</span> ) \</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>        | map{ el -&gt; [</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>            el.<span class="fu">baseName</span>.<span class="fu">toString</span>(),</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>            el,</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;output&quot;</span> : <span class="st">&quot;output_from_${el.baseName}.txt&quot;</span>,</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;id&quot;</span>: el.<span class="fu">baseName</span>,</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;operator&quot;</span> : <span class="st">&quot;-&quot;</span>,</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;term&quot;</span> : <span class="dv">10</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>          ]} \</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>        | process_step18 \</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>        | view{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>] ] }</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In order to make a bit more sense of the (gradually growing) configuration map that is sent to the <code>process</code>, we tuned the layout a bit. In this case, the output filename that is configured contains an identifier for the input as well. In this way, the output is always unique.</p>
<p>Since we have configured <code>params.input</code> in <code>nextflow.config</code>, we are able to just run our new <em>pipeline</em>:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step18</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input1</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/24/2604a5616cc0ff5a201b3ae895b30e/output_from_input1.txt]</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input3</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/8a/7196136a0a59dbe52dc389b12d188c/output_from_input3.txt]</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input2</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/8e/4b0dc043320e68358c0f7d6aa7d67c/output_from_input2.txt]</span></code></pre></div>
<div class="sourceCode" id="cb55"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="fu">ls</span> -1 output/output_from*</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="ex">output/output_from_input1.txt</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="ex">output/output_from_input2.txt</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="ex">output/output_from_input3.txt</span></span></code></pre></div>
<p>In other words, this allows to distinguish between parallel branches in the pipeline.</p>
<p>Please note that if we add steps to the <em>pipeline</em>, because the output is reported as input for the next <code>process</code>, it automatically points to the correct filename even though the next process is not aware of the way the output filename has been specified. That’s nice.</p>
<h2 id="step-19---use-a-closure">Step 19 - Use a closure</h2>
<p>We mentioned that there are 2 ways to pass an output filename to a <code>process</code>. There is a third one, using a closure or function to handle the naming for us.</p>
<p>Let us illustrate this with an example again:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 19</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="dt">def</span> out_from_in = { it -&gt; it.<span class="fu">baseName</span> + <span class="st">&quot;-out.txt&quot;</span> }</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>process process_step19 {</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;output&quot;</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    input:</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(id), <span class="fu">file</span>(input), <span class="fu">val</span>(config)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    output:</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">file</span>(<span class="st">&quot;${out}&quot;</span>), <span class="fu">val</span>(<span class="st">&quot;${config}&quot;</span>)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    script:</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>        out = <span class="fu">out_from_in</span>(input)</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="st">        a=`cat $input`</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="st">        let result=&quot;\$a + ${config.term}&quot;</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;\$result&quot; &gt; ${out}</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>workflow step19 {</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span>.<span class="fu">fromPath</span>( params.<span class="fu">input</span> ) \</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>        | map{ el -&gt; [</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>            el.<span class="fu">baseName</span>.<span class="fu">toString</span>(),</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>            el,</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;id&quot;</span>: el.<span class="fu">baseName</span>,</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;operator&quot;</span> : <span class="st">&quot;-&quot;</span>,</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;term&quot;</span> : <span class="dv">10</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>          ]} \</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>        | process_step19 \</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>        | view{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>] ] }</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The result is as follows:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step19</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input1</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/8a/a1028933fabcf4eb716484634c4a52/input1-out.txt]</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input3</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/81/292709056975b28be4e5f74aba559d/input3-out.txt]</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input2</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/01/7affdbd5d1f6e53b055028db85bb59/input2-out.txt]</span></code></pre></div>
<p>We can even add the closure to the configuration map sent to the <code>process</code>, but NextFlow complains that this is not serializable so you may miss some features and most importantly it may not work at all times:</p>
<pre><code>WARN: Cannot serialize context map. Cause: java.lang.IllegalArgumentException: Unknown workflow parameter definition: map -- Resume will not work on this process</code></pre>
<p>This approach may seem like completely over-engineered but for a lot of use-cases it turns out to be a good fit. Although, not in the way we introduced it here. We come back to that later…</p>
<blockquote>
<p>A DiFlow module contains a function definition that takes the input file name as input and <em>generates</em> an output filename.</p>
</blockquote>
<h2 id="step-20---the-order-of-events-in-a-stream">Step 20 - The order of events in a stream</h2>
<p>We touch upon a point that we have encountered but not really considered in-depth: the order of <em>things</em> in the <code>Channel</code> or stream. We’ve noticed that the order is not predictable and we’ve discussed that this is to be expected. In general, the duration of a <code>process</code> step may depend on the data or the number of resources available at the time of running. Also, the example where we joined the different parallel branches (Step 12 - <strong>REF</strong>) was independent of the order because it just calculated the sum.</p>
<p>Another consequence of the undetermined order of <em>events</em> is the fact that during a join or reduce phase (for instance with <code>toList</code>), the resulting order is undetermined and this messes up the caching functionality of NextFlow.</p>
<p>Let us give an example with a reduce process that <em>does</em> depend on the order of <em>events</em>. We divide the first element from the <em>map</em> phase by the second one:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 20a</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>process process_step20 {</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    input:</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(id), <span class="fu">val</span>(input), <span class="fu">val</span>(term)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    output:</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">val</span>(output), <span class="fu">val</span>(<span class="st">&quot;${term}&quot;</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    exec:</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>        output = input[<span class="dv">0</span>] / input[<span class="dv">1</span>]</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>workflow step20a {</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span> ] ) \</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>        | map{ el -&gt; [ el.<span class="fu">toString</span>(), el, <span class="dv">10</span> ] } \</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>        | process_step10a \</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>        | toList \</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>        | map{ [</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;sum&quot;</span>,</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>                  it.<span class="fu">collect</span>{ id, value, config -&gt; value },</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>                  [ : ]</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>               ] } \</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>        | process_step20 \</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>        | view{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>] ] }</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>If you run this code like this, you get something like this when launching multiple times:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step20a -with-docker</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">sum</span>, 0.9166666667]</span></code></pre></div>
<div class="sourceCode" id="cb61"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step20a -with-docker</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">sum</span>, 1.0909090909]</span></code></pre></div>
<p>As an illustration, I’ve added the <code>-with-docker</code> option.</p>
<p>Luckily, there is a variant of the <code>toList</code> channel operator that takes into account sorting: <code>toSortedList</code>. There are other operators as well, but we leave it as an exercise to look those up. The <code>workflow</code> code above simply becomes:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 20b</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>workflow step20b {</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span> ] ) \</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>        | map{ el -&gt; [ el.<span class="fu">toString</span>(), el, <span class="dv">10</span> ] } \</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>        | process_step10a \</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        | toSortedList{ a,b -&gt; a[<span class="dv">0</span>] &lt;=&gt; b[<span class="dv">0</span>] } \</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>        | map{ [ <span class="st">&quot;sum&quot;</span>, it.<span class="fu">collect</span>{ id, value, config -&gt; value }, [ : ] ] } \</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>        | process_step20 \</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>        | view{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>] ] }</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In this example, we sort (alphabetically) on the id in the triplet.</p>
<h2 id="step-21---is-the-triplet-really-necessary">Step 21 - Is the <em>triplet</em> really necessary?</h2>
<p>A <code>process</code> can take multiple input <code>Channel</code>s. But then why are struggling with triplets above? Why do we make our life harder than it could be? Let us illustrate this with a little example. We define a process that takes two input <code>Channel</code>s, one containing integers and the other with strings. We simply concatenate both in the process definition:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 21</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>process process_step21 {</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    input:</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">val</span>(in1)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">val</span>(in2)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    output:</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">val</span>(out)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    exec:</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>        out = in1 + in2</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>workflow step21 {</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    ch1_ = <span class="bu">Channel</span>.<span class="fu">from</span>( [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span> ] )</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    ch2_ = <span class="bu">Channel</span>.<span class="fu">from</span>( [<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>, <span class="st">&quot;d&quot;</span> ] )</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">process_step21</span>(ch1_, ch2_) | toSortedList | view</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>If we run this, we get the following result:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step21 -with-docker</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">1a</span>, 2b, 3c, 4d]</span></code></pre></div>
<p>This seems fine, it is probably what was expected to happen. If we slightly change the workflow and add a <code>process</code> step we defined earlier (<code>add</code>):</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 21a</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>workflow step21a {</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    ch1_ = <span class="bu">Channel</span>.<span class="fu">from</span>( [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span> ] ) | add</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    ch2_ = <span class="bu">Channel</span>.<span class="fu">from</span>( [<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>, <span class="st">&quot;d&quot;</span> ] )</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">process_step21</span>(ch1_, ch2_) | toSortedList | view</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Running this two times should reveal the caveat we want to point out;</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step21a -with-docker</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">2b</span>, 3a, 4d, 6c]</span></code></pre></div>
<div class="sourceCode" id="cb67"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step21a -with-docker</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">2b</span>, 3a, 4c, 5d]</span></code></pre></div>
<p>The result is not deterministic. Imagine you want to combine two input <code>Channel</code>s like this, but one of the <code>Channel</code>s requires some additional processing first (creating an index or a qc report) then relying on the order of operations not consistent.</p>
<p>In other words, we need to stick to adding an explicit <code>ID</code> and add it with the config to the triplet.</p>
<h2 id="step-22---toward-generic-processes">Step 22 - Toward generic processes</h2>
<p>Dealing with computational pipelines, and looking at the examples above and beyond, we note that the <code>input</code> of a process is always the same: a triplet. The output should at least contain the <code>ID</code> and the path to the output file or directory. We want to provide the <code>ConfigMap</code> as output as well, so that input and output become consistent and we can easily chain processes.</p>
<p>Going a step further, we might reflect on the nature of the script-part of a <code>process</code> definition. It contains one or more commands, each with options. For the sake of the argument, let’s say we need to run one command. We already know how we can provide parameters for input and output. We can now also go a step further.</p>
<p>We could, for instance, provide the full command line instruction via the <code>ConfigMap</code>:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step - 22</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>process process_step22 {</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;output&quot;</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    input:</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(id), <span class="fu">file</span>(input), <span class="fu">val</span>(config)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    output:</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>        tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">file</span>(<span class="st">&quot;${config.output}&quot;</span>), <span class="fu">val</span>(<span class="st">&quot;${config}&quot;</span>)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    script:</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="st">        ${config.cli}</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>workflow step22 {</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span>.<span class="fu">fromPath</span>( params.<span class="fu">input</span> ) \</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>        | map{ el -&gt; [</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>            el.<span class="fu">baseName</span>.<span class="fu">toString</span>(),</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>            el,</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;cli&quot;</span>: <span class="st">&quot;cat input.txt &gt; output22.txt&quot;</span>,</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;output&quot;</span>: <span class="st">&quot;output22.txt&quot;</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>          ]} \</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>        | process_step22 \</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>        | view{ [ it[<span class="dv">0</span>], it[<span class="dv">1</span>] ] }</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a><span class="co">//- - -</span></span></code></pre></div>
<p>Such that</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> -q run . -entry step22 --input data/input.txt</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>[<span class="ex">input</span>, <span class="op">&lt;</span>...<span class="op">&gt;</span>/work/3b/76ea2bf0aca48910fd543494df36cf/output22.txt]</span></code></pre></div>
<p>Unsurprisingly, the content of <code>output22.txt</code> is the same as that of <code>input.txt</code>:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="fu">cat</span> output/output22.txt</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span></span></code></pre></div>
<p>This may seem silly, but let us make a few remarks anyway:</p>
<ol type="1">
<li>The output file name is specified in two places, that is not a good idea</li>
<li>The input file name is specified explicitly in the <code>cli</code> definition. We could get around by by pointing to <code>params.input</code> instead, keeping in mind correct escaping and such. It could work, but would be error prone.</li>
<li>One could be tempted (we were) to indeed create 1 generic process handler, but when looking at a pipeline run, one would not be able to distinguish the different processes from each other because the name of the process is used as an identifier.</li>
</ol>
<p>So, while this may seem like a stupid thing to do, we use a method that is very similar to this in DiFlow. Keeping into account the above points, that is…</p>
<p>In practice, we do not specify the command line like shown above, but rather by specifying the command and options by means of the <code>ConfigMap</code> for that specific process. Let us give an example:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>params {</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  cellranger {</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    name = <span class="st">&quot;cellranger&quot;</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    container = <span class="st">&quot;mapping/cellranger:4.0.0-1&quot;</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    command = <span class="st">&quot;cellranger&quot;</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    arguments {</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>      mode {</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>        name = <span class="st">&quot;mode&quot;</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>        otype = <span class="st">&quot;--&quot;</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>        description = <span class="st">&quot;The run mode&quot;</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>        value = <span class="st">&quot;count&quot;</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>      input {</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>        name = <span class="st">&quot;input&quot;</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>        otype = <span class="st">&quot;--&quot;</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>        description = <span class="st">&quot;Path of folder created by mkfastq or bcl2fastq&quot;</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>        required = <span class="kw">false</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>      id {</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>        name = <span class="st">&quot;id&quot;</span></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>        otype = <span class="st">&quot;--&quot;</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>        description = <span class="st">&quot;Output folder for the count files.&quot;</span></span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>        value = <span class="st">&quot;cr&quot;</span></span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>        required = <span class="kw">false</span></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>      ...</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>In reality, this is still a simplified version because we also use variables in <code>nextflow.config</code> but that is only for convenience.</p>
<p>The above is a representation of the command-line instruction to be provided inside a container (<code>mapping/cellranger:4.0.0-1</code>). The command itself is <code>cellranger</code> and the different options are listed as keys under <code>arguments</code>.</p>
<blockquote>
<p>Every DiFlow module has its own <code>nextflow.config</code> that contains a representation of the CLI instruction to run as well as a pointer to the container to be used for running.</p>
</blockquote>
<p>We have a function in NextFlow that takes <code>params.cellranger</code> and creates the CLI that corresponds to it. Values for <code>input</code> and <code>output</code> are set during the pipeline run based on the input provided and a closure for generating the output file name. To give an idea of what this CLI rendering looks like, this is what we use in DiFlow:</p>
<p>A <code>nextflow.config</code> file with content like above is created for every <em>module</em>, i.e., for every processing step in the pipeline. On the level of the pipeline those config files are sourced, i.e.:</p>
<pre><code>includeConfig &#39;&lt;...&gt;/nextflow.config&#39;</code></pre>
<p>It may seem like a daunting task to create a config file like this for every computational step, and it is. We are not doing this manually as that would be too error-prone and frustrating on top of that. We are just laying out the principles here, later we will see how <code>viash</code> can create the <code>nextflow.config</code> file for us.</p>
<p>Transforming the relevant section in <code>nextflow.config</code> to a command-line instruction is done by a Groovy function that simply parses the <code>ConfigMap</code>.</p>
<h2 id="step-23---more-than-one-input">Step 23 - More than one input</h2>
<p>It may appear in the above example that input can only be provided as one variable or file. NextFlow allows you to specify not only wildcards (<code>*</code> for instance) but also arrays. This comes in handy when multiple input file reference need to be provided on the CLI. For instance, when doing a mapping step we usually need to provide a reference file. We could add this reference file as a parameter (and take it up in <code>nextflow.config</code> but then it would just be seen as a string value. NextFlow can not know then that it has to check for existence of the file prior to starting to run the process<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<p>How does a DiFlow module know then what file reference is related to what option on the CLI? We would obviously not want to run <code>CellRanger count</code> on a reference file as input and use a <code>fastq</code> file as reference (as if that would work?!). That means we have to be sure to somehow let the DiFlow module know what file references correspond to what options on the CLI.</p>
<p>There are three possibilities:</p>
<ol type="1">
<li><p>There is only one input file: in this case we just have to make sure it is passed as a <code>Path</code> object to the DIFlow module.</p></li>
<li><p>There are multiple input files but they correspond to the same option on the CLI. For instance, <code>cat</code>’ing multiple files where order is not relevant. In this case, we can simply pass a <code>List[Path]</code> to the DiFlow module.</p></li>
<li><p>There are multiple input files corresponding to the different options on the CLI, for instance CellRanger with input and a reference file. In this case, we pass something like</p></li>
</ol>
<div class="sourceCode" id="cb73"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>[ <span class="st">&quot;input&quot;</span>: <span class="st">&quot;&lt;fastq-dir&gt;&quot;</span>, <span class="st">&quot;reference&quot;</span>: <span class="st">&quot;&lt;reference-dir&gt;&quot;</span> ]</span></code></pre></div>
<p>While there may be still other possibilities that we may encounter in the future, these three are covered by the current implementation of DiFlow.</p>
<blockquote>
<p>A DiFlow module contains the necessary logic to parse three types of datastructures as input file references: <code>Path</code>, <code>List[Path]</code> and <code>Map[String, List[Path]]</code>.</p>
</blockquote>
<p><strong>Remark:</strong> that the easiest way to create a <code>Path</code> object with the proper pointers in a NextFlow context is to use the built-in <code>file()</code> function. It simply takes a <code>String</code> argument pointing to the file (either relative or absolute).</p>
<p>There’s some more magic going on in the background. For starters, if you specify just either <code>Path</code> or <code>List[Path]</code>, the DiFlow module will retrieve the appropriate command-line option to associate it with <em>automagically</em>. This way, as a pipeline developer you usually should not care about what exact command line option is necessary for your input data to be processed.</p>
<h2 id="step-24---workflow-instead-of-process">Step 24 - <code>workflow</code> instead of <code>process</code></h2>
<p>We already have quite some helper functionality that should be provided by a DiFlow module:</p>
<ul>
<li>Generating an output file name based on input</li>
<li>Parsing different types of input file references</li>
<li>Selecting the proper key from the (large) <code>ConfigMap</code> stored in the global <code>params</code> <code>Map</code>.</li>
<li>Generating the CLI from <code>nextflow.config</code></li>
<li>Providing a test case for the module</li>
</ul>
<p>There is some hidden functionality as well:</p>
<ul>
<li>Making sure input and output file references are updated in the <code>ConfigMap</code></li>
<li>Dealing with per-sample configuration (upcoming feature)</li>
</ul>
<p>As it turns out, providing all this functionality in a <code>process</code> is not the proper way to go, and is even expected not to work. Luckily we can define <code>workflow</code>s in NextFlow’s DSL2 syntax. Such a <code>workflow</code> can be used just like a <code>process</code> in the above example as long as we take care that the input/output signatures are aligned with what is expected.</p>
<p>The added benefit of using a <code>workflow</code> rather than a <code>process</code> is that the underlying <code>process</code> can have a different signature. In practice, this is what a DiFlow <code>process</code> looks like:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>process cellranger_process {</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  container <span class="st">&quot;${params.dockerPrefix}${container}&quot;</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  publishDir <span class="st">&quot;${params.output}/processed_data/${id}/&quot;</span>, mode: <span class="st">&#39;copy&#39;</span>, overwrite: <span class="kw">true</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  input:</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(id), <span class="fu">path</span>(input), <span class="fu">val</span>(output), <span class="fu">val</span>(container), <span class="fu">val</span>(cli)</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    tuple <span class="fu">val</span>(<span class="st">&quot;${id}&quot;</span>), <span class="fu">path</span>(<span class="st">&quot;${output}&quot;</span>)</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>  script:</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="st">    export PATH=&quot;${moduleDir}:\$PATH&quot;</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="st">    $cli</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>As can be seen, the <code>ConfigMap</code> is not passed to the <code>process</code> but instead the information in <code>params</code> is used to generate an <code>output</code> filename, extract the container image and generate the CLI instruction. Please note that <code>input</code> here points to ALL possible input file references as per Step 23.</p>
<p>The <code>workflow</code> that points to this <code>process</code> is then defined as follows:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>workflow cellranger {</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  take:</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    id_input_params_</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  main:</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    result_ =  ...</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  emit:</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>    result_</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="step-25---custom-scripts">Step 25 - Custom scripts</h2>
<p>The attentive reader may have noticed the instruction in the <code>script</code> section in Step 24. It adds the directory of the current <em>module</em> to the <code>$PATH</code>. This allows us to store scripts or binaries with the NextFlow module and still be able to call those, even if NextFlow runs all processes from their own private <code>work</code> directory.</p>
<h2 id="step-26---the-missing-link">Step 26 - The missing link</h2>
<p>Creating and maintaining all the necessary files for a modules, especially with the amount of (duplicate) boilerplate code in each of them may seem like a daunting task. It is… Therefore, we developed a tool that is able to add the boilerplate for us: <code>viash</code>.</p>
<p><a href="To%20be%20open-sourced%20soon!"><code>viash</code></a> takes as input a specification of a command/tool, how to run and test it. <code>viash</code> can then turn this specification into runnable script, a containerized executable or a NextFlow module.</p>
<h2 id="putting-it-all-together">Putting it all together</h2>
<p>In the end, a <em>module</em> consists of the following:</p>
<ul>
<li><p><code>main.nf</code> contains the code for <code>workflow</code> and <code>process</code> definition. We duplicate ALL the parsing code (for CLI, input, <code>ConfigMap</code>, etc.) in order for a module to be effectively standalone.</p></li>
<li><p><code>nextflow.config</code> contains the <code>ConfigMap</code> for this specific module, scoped properly.</p></li>
<li><p>Executables or scripts required to be on the <code>$PATH</code> for this module to run inside the container defined in <code>nextflow.config</code>.</p></li>
</ul>
<p>In what follows, we will point to an example pipeline in <a href="https://github.com/data-intuitive/viash_docs/blob/master/examples/civ6_postgame/main.nf">viash_docs</a>. This repository contains the source files needed to <em>generate</em> the DiFlow modules.</p>
<p>Creating a pipeline from these modules is now a matter of:</p>
<h3 id="generate-the-modules">Generate the modules</h3>
<p>Using <code>viash</code>, it’s easy to go from the component definitions under <code>src/</code> to proper DiFlow modules:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="ex">viash</span> ns build -p docker --setup</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="ex">viash</span> ns build -p nextflow</span></code></pre></div>
<p>The first instruction builds the Docker containers needed for the pipeline to work. The second one builds the NextFlow/DiFlow modules.</p>
<p>Please note that <code>viash</code> allows you to also export to native or containerized binaries as well as run unit tests for the components. This, though, is covered elsewhere.</p>
<h3 id="pipeline-main.nf">Pipeline <code>main.nf</code></h3>
<p>The pipeline logic is contained in <code>main.nf</code>. In order to use the modules defined using DiFlow, they have to be imported. This is the full <code>main.nf</code> file for the civ6_postgame pipeline:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>nextflow.<span class="fu">preview</span>.<span class="fu">dsl</span>=<span class="dv">2</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span><span class="im"> java.nio.file.Paths</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>include  plot_map       from  <span class="st">&#39;./target/nextflow/civ6_save_renderer/plot_map/main.nf&#39;</span>       <span class="fu">params</span>(params)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>include  combine_plots  from  <span class="st">&#39;./target/nextflow/civ6_save_renderer/combine_plots/main.nf&#39;</span>  <span class="fu">params</span>(params)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>include  convert_plot   from  <span class="st">&#39;./target/nextflow/civ6_save_renderer/convert_plot/main.nf&#39;</span>   <span class="fu">params</span>(params)</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>include  parse_header   from  <span class="st">&#39;./target/nextflow/civ6_save_renderer/parse_header/main.nf&#39;</span>   <span class="fu">params</span>(params)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>include  parse_map      from  <span class="st">&#39;./target/nextflow/civ6_save_renderer/parse_map/main.nf&#39;</span>      <span class="fu">params</span>(params)</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>include  rename         from  <span class="st">&#39;./src/utils.nf&#39;</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>workflow {</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> (params.<span class="fu">debug</span> == <span class="kw">true</span>)</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span>(params)</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> (!params.<span class="fu">containsKey</span>(<span class="st">&quot;input&quot;</span>) || params.<span class="fu">input</span> == <span class="st">&quot;&quot;</span>) {</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>        exit <span class="dv">1</span>, <span class="st">&quot;ERROR: Please provide a --input parameter pointing to .Civ6Save file(s)&quot;</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">def</span> input_ = <span class="bu">Channel</span>.<span class="fu">fromPath</span>(params.<span class="fu">input</span>)</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">def</span> listToTriplet = { it -&gt; [ <span class="st">&quot;all&quot;</span>, it.<span class="fu">collect</span>{ a -&gt; a[<span class="dv">1</span>] }, params ] }</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>    input_ \</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>        | map{ it -&gt; [ it.<span class="fu">baseName</span> , it ] } \</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>        | map{ it -&gt; [ it[<span class="dv">0</span>] , it[<span class="dv">1</span>], params ] } \</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>        | ( parse_header &amp; parse_map ) \</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>        | join \</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>        | map{ id, parse_headerOut, params1, parse_mapOut, params2 -&gt;</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>            [ id, [ <span class="st">&quot;yaml&quot;</span> : parse_headerOut, <span class="st">&quot;tsv&quot;</span>: parse_mapOut ], params1 ] } \</span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>        | plot_map \</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>        | convert_plot \</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>        | rename \</span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>        | toSortedList{ a,b -&gt; a[<span class="dv">0</span>] &lt;=&gt; b[<span class="dv">0</span>] }  \</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>        | <span class="fu">map</span>( listToTriplet ) \</span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>        | combine_plots</span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Given the steps described above, we estimate that it’s possible to understand this pipeline.</p>
<h3 id="pipeline-nextflow.config">Pipeline <code>nextflow.config</code></h3>
<p>This is the config file for the pipeline:</p>
<pre><code>includeConfig &#39;target/nextflow/civ6_save_renderer/plot_map/nextflow.config&#39;
includeConfig &#39;target/nextflow/civ6_save_renderer/combine_plots/nextflow.config&#39;
includeConfig &#39;target/nextflow/civ6_save_renderer/convert_plot/nextflow.config&#39;
includeConfig &#39;target/nextflow/civ6_save_renderer/parse_header/nextflow.config&#39;
includeConfig &#39;target/nextflow/civ6_save_renderer/parse_map/nextflow.config&#39;

docker {
  runOptions = &quot;-i -v ${baseDir}:${baseDir}&quot;
}</code></pre>
<h3 id="running-the-pipeline">Running the pipeline</h3>
<div class="sourceCode" id="cb79"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="ex">nextflow</span> run . <span class="kw">\</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">--input</span> <span class="st">&quot;data/*.Civ6Save&quot;</span> <span class="kw">\</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">--output</span> <span class="st">&quot;output/&quot;</span> <span class="kw">\</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">--combine_plots__framerate</span> 1 <span class="kw">\</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="ex">N</span> E X T F L O W  ~  version 20.10.0</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Launching</span> <span class="kw">`</span><span class="ex">./main.nf</span><span class="kw">`</span> [serene_mercator] - revision: 86da0cc3ec</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a><span class="ex">executor</span> <span class="op">&gt;</span>  local (26)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>[<span class="ex">2c</span>/<span class="ex">970402</span>] process <span class="op">&gt;</span> parse_header:parse_header_process (AutoSave_0158) [<span class="ex">100%</span>] 5 of 5 ✔</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>[<span class="ex">7d</span>/<span class="ex">c19cfa</span>] process <span class="op">&gt;</span> parse_map:parse_map_process (AutoSave_0162)       [<span class="ex">100%</span>] 5 of 5 ✔</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>[<span class="ex">06</span>/<span class="ex">4b19be</span>] process <span class="op">&gt;</span> plot_map:plot_map_process (AutoSave_0160)         [<span class="ex">100%</span>] 5 of 5 ✔</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>[<span class="ex">fc</span>/<span class="ex">3f219c</span>] process <span class="op">&gt;</span> convert_plot:convert_plot_process (AutoSave_0162) [<span class="ex">100%</span>] 5 of 5 ✔</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>[<span class="ex">f2</span>/<span class="ex">c24399</span>] process <span class="op">&gt;</span> rename (AutoSave_0162)                            [<span class="ex">100%</span>] 5 of 5 ✔</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>[<span class="ex">fb</span>/<span class="ex">43a707</span>] process <span class="op">&gt;</span> combine_plots:combine_plots_process (all)         [<span class="ex">100%</span>] 1 of 1 ✔</span></code></pre></div>
<p>Please note that we use an option <code>--combine_plots__framerate 1</code>. This points to an option of the <code>combine_plots</code> module that is called <code>framerate</code>. In other words, if a module defines an option (corresponding to a CLI option) it can be overridden from the CLI by using the convention <code>&lt;module_name&gt;__&lt;module option&gt; &lt;value&gt;</code><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<h1 id="what-is-missing-from-diflow">What is missing from DiFlow?</h1>
<h2 id="parameter-checks">Parameter checks</h2>
<p>We currently do no checks on variables that are set through the <code>ConfigMap</code>.</p>
<h2 id="multiple-output-file-references">Multiple output file references</h2>
<p>We make an implicit assumption all of the above that the output of a pipeline step is a single file, or a single directory or a set of files that relate to each other. What we don’t cover yet is a component that outputs both the results of analysis and a report, for instance. The reason for this is not technical but rather that it breaks the logical flow of a pipeline definition.</p>
<p>We currently output 1 <em>type</em> of output from a module, and that allows us to easily chain modules. A module that would output 2 types of data would essentially be a fork in the pipeline process. That means that either the next component knows to expect these two outputs as inputs or we have to explicitly deal with the two branches of the fork. But then we can not longer write pipelines like:</p>
<pre><code>step1 | step2 | step3</code></pre>
<p>There is a simple workaround for this kind of situation: Make two components/modules that each output either of the outputs. This fits in the API of a modules and those can again be chained easily. Having said that, we are thinking of ways to allow the output of multiple output files because this workaround is not efficient at all.</p>
<h2 id="per-sample-configuration">Per-sample configuration</h2>
<p>When running different samples in parallel, one may sometimes want to have parameters specific to a sample. Filter threshold, for instance, may be different from sample to sample. Implementing this in DiFlow is not hard per se, it is more a matter of coming up with a good way to encode this in <code>nextflow.config</code> and the <code>ConfigMap</code>.</p>
<hr />
<h1 id="extras">Extras</h1>
<h2 id="conditional-logic">Conditional logic</h2>
<p>Let us consider a different topic: high-level pipeline logic. Sometimes, one want to provide the option to run just part of a pipeline, or support branches in the logic depending on a parameter or even a result of a pipeline processing step.</p>
<p>Let us assume a couple of steps in a pipeline, each represented by a <code>map</code> to make the code easier to read. The code below splits apart the logic of running a specific step from the one of the pipeline itself.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>workflow runOrSkip {</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    take:</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    data_          <span class="co">// Data Channel</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    thisProcess    <span class="co">// The map, process or workflow to run</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    runOrNot       <span class="co">// Function/closure to check if step needs to run, returns Boolean</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    thisStep       <span class="co">// The current step to run or not</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    main:</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    runStep_ = data_.<span class="fu">branch</span>{ it -&gt;</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>            run: <span class="fu">runOrNot</span>(thisStep)</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>            skip: ! <span class="fu">runOrNot</span>(thisStep)</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>    step_ = runStep_.<span class="fu">run</span> \</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>        | thisProcess \</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>        | <span class="fu">mix</span>(runStep_.<span class="fu">skip</span>) \</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>    emit:</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>    step_</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a><span class="dt">def</span> <span class="fu">runOrNot</span>(thisStep) {</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">def</span> STEPS = [ <span class="st">&quot;step1&quot;</span>, <span class="st">&quot;step2&quot;</span>, <span class="st">&quot;step3&quot;</span>, <span class="st">&quot;step4&quot;</span>, <span class="st">&quot;step5&quot;</span> ]</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">def</span> steps = params.<span class="fu">steps</span>.<span class="fu">split</span>(<span class="st">&quot;,&quot;</span>)</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>                    .<span class="fu">collect</span>{ it -&gt;</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>                        (it.<span class="fu">contains</span>(<span class="st">&quot;-&quot;</span>))</span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>                            ? STEPS[STEPS.<span class="fu">indexOf</span>(it.<span class="fu">split</span>(<span class="st">&quot;-&quot;</span>)[<span class="dv">0</span>])..<span class="fu">STEPS</span>.<span class="fu">indexOf</span>(it.<span class="fu">split</span>(<span class="st">&quot;-&quot;</span>)[<span class="dv">1</span>])]</span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>                            : it</span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>                    }.<span class="fu">flatten</span>()</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> steps.<span class="fu">contains</span>(thisStep)</span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>workflow stepA2 {</span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>    input_ = <span class="bu">Channel</span>.<span class="fu">from</span>( [ <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> ] )</span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>    step1_ = <span class="fu">runOrSkip</span>(input_, map{ it -&gt; it * <span class="dv">2</span> }, runOrNot, <span class="st">&quot;step1&quot;</span>)</span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>    step2_ = <span class="fu">runOrSkip</span>(step1_, map{ it -&gt; it + <span class="dv">5</span> }, runOrNot, <span class="st">&quot;step2&quot;</span>)</span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a>    step3_ = <span class="fu">runOrSkip</span>(step2_, map{ it -&gt; it / <span class="dv">2</span> }, runOrNot, <span class="st">&quot;step3&quot;</span>)</span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a>    step4_ = <span class="fu">runOrSkip</span>(step3_, map{ it -&gt; it + <span class="dv">1</span> }, runOrNot, <span class="st">&quot;step4&quot;</span>)</span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a>    step5_ = <span class="fu">runOrSkip</span>(step4_, map{ it -&gt; it + <span class="dv">5</span> }, runOrNot, <span class="st">&quot;step5&quot;</span>)</span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a>    step5_.<span class="fu">view</span>{ it }</span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The result is exactly what we wanted, a flexible approach to selecting possible steps in a pipeline:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>$ <span class="va">NXF_VER=</span>20.04.1-edge <span class="ex">nextflow</span> run . -entry stepA2 -with-docker --steps <span class="st">&quot;step1-step3,step5&quot;</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="ex">N</span> E X T F L O W  ~  version 20.04.1-edge</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Launching</span> <span class="kw">`</span><span class="ex">./main.nf</span><span class="kw">`</span> [drunk_becquerel] - revision: 3672a5b1b7</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="ex">WARN</span>: DSL 2 IS AN EXPERIMENTAL FEATURE UNDER DEVELOPMENT -- SYNTAX MAY CHANGE IN FUTURE RELEASE</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="ex">8.5</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="ex">9.5</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="ex">10.5</span></span></code></pre></div>
<p>Please note that we do perform any checks on whether the <code>steps</code> parameter is provided or it has the correct format. We leave this as an exercise.</p>
<h2 id="variables-in-nextflow.config">Variables in <code>nextflow.config</code></h2>
<p>CLI arguments and options for specific components/steps in the pipeline are configured in the respective <code>nextflow.config</code> files that are imported in the global one. But that also means that we can not override them from the CLI anymore. For instance, it is not possible to add an argument in the style <code>--component.input.value &lt;value&gt;</code>. That means that all options would either be fixed for the whole pipeline, or to be configured in <code>nextflow.config</code> explicitly. The latter is possible by means of a custom config file that overrides the other settings.</p>
<p>There is, however, an easier approach to this: variables in <code>nextflow.config</code>. The functionality is explained <a href="https://www.nextflow.io/docs/latest/config.html#config-variables">here</a> and is used in DiFlow for allowing us to provide the (scoped) parameter values on the CLI. For instance, this is an excerpt from an existing component’s <code>nextflow.config</code>:</p>
<pre><code>params {
  ...
  cellranger_vdj__id = &quot;cr&quot;
  ...
  cellranger_vdj {
    name = &quot;cellranger_vdj&quot;
    container = &quot;mapping/cellranger_vdj/cellranger_vdj:4.0.0-1&quot;
    command = &quot;cellranger_vdj&quot;
    arguments {
      ...
      id {
        name = &quot;id&quot;
        otype = &quot;--&quot;
        value = &quot;${params.cellranger_vdj__id}&quot;
        ...
      }
      ...</code></pre>
<p>If you look at this one parameter for the <code>cellranger_vdj</code> component, you notice that directly under <code>params</code>, we have the key <code>cellranger_vdj__id</code>. In other words, the component name followed by a double underscore and then the parameter name. Since all arguments are named here, we do not have to have to specify <code>-</code>’s or <code>--</code>’s.</p>
<hr />
<h1 id="appendix">Appendix</h1>
<h2 id="caveats-and-tips">Caveats and Tips</h2>
<h3 id="resources">Resources</h3>
<p>When you run or export with the <code>DockerTarget</code>, resources are automatically added to the running container and stored under <code>/resources</code>. In case of the <code>NativeTarget</code>, this is not the case and since <code>NextFlowTarget</code> uses the <code>NativeTarget</code> it’s the same there. That does not mean that resources specified in <code>functionality.yaml</code> is not available in these cases, we only have to point to them where appropriate.</p>
<p>The following snippet (from <code>ct/singler</code>) illustrates this:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>par <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">input =</span> <span class="st">&quot;input.h5ad&quot;</span>,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="st">&quot;output.h5ad&quot;</span>,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">reference =</span> <span class="st">&quot;HPCA&quot;</span>,</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">outputField =</span> <span class="st">&quot;cellType&quot;</span>,</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pruningMADS =</span> <span class="dv">3</span>,</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">outputFieldPruned =</span> <span class="st">&quot;celltype-pruned&quot;</span>,</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">reportOutputPath =</span> <span class="st">&quot;report.md&quot;</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a><span class="do">## VIASH </span><span class="re">END</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>par<span class="sc">$</span>resources_dir <span class="ot">&lt;-</span> resources_dir</span></code></pre></div>
<p>In other words, <code>resources_dir</code> is automatically created by <code>viash</code> in all current 3 environments. This means that we can point to the <code>report.Rmd</code> file present in the resources like so:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>rmarkdown<span class="sc">::</span><span class="fu">render</span>(<span class="fu">paste0</span>(par<span class="sc">$</span>resources_dir, <span class="st">&quot;/&quot;</span>, <span class="st">&quot;report.Rmd&quot;</span>), <span class="at">output_file =</span> par<span class="sc">$</span>reportOutputPath)</span></code></pre></div>
<h3 id="default-values">Default values</h3>
<p>In functionality, no option should have an empty string as value!</p>
<h3 id="target_image"><code>target_image</code></h3>
<p>It makes sense to add the <code>target_image</code> attribute in the <code>docker_platform.yaml</code> file. This way, the resulting container image is predictable, rather than an autogenerated tag from <code>viash</code>.</p>
<h3 id="running-the-docker-setup">Running the Docker setup</h3>
<p>We don’t have a solution yet for pre-generating the Docker images prior to starting a NXF pipeline. For the moment, we ask the user to run the build script for the Docker targets with the <code>---setup</code> option. This only works locally, it would for instance not work on a different (clean) node or in a Kubernetes cluster.</p>
<p>We are working on solutions or workarounds for this. Keep you posted!</p>
<h2 id="open-issues">Open issues</h2>
<ol type="1">
<li><p>Multiple files as input for a component: E.g. the concat component uses multiple files to be joined. At the moment this does not seems to be possible.</p></li>
<li><p>Use of additional input files into a specific component. Some components do not only have input/output but require additional input. How should we map this?</p></li>
</ol>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>DiFlow stands for <code>[NextFlow] D[SL2] I[mprovement] Flow</code> or maybe also <code>D[ata] I[ntuitive] Flow</code>?<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>It <em>is</em> possible in some cases however to manipulate the <code>Channel</code> such that a process is effectively run twice on the same data, but that is a more advanced topic.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>There is more in fact: NextFlow has some logic on how to deal with input files/directories when using Docker. It will mount the volumes that contain input references. If we just add an input file reference as a string variable to the CLI, it will not be visible inside the Docker container at runtime.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>See below for more information about this and how this is encoded in <code>nextflow.config</code>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
</body>
</html>
